<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸ƒé—®ä¿å­˜å¤±è´¥è¯Šæ–­å·¥å…·</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">ğŸ” ä¸ƒé—®ä¿å­˜å¤±è´¥è¯Šæ–­å·¥å…·</h1>

    <!-- ç”¨æˆ·ä¿¡æ¯ -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4">å½“å‰ç”¨æˆ·ä¿¡æ¯</h2>
      <div id="userInfo" class="space-y-2">
        <p><strong>ç”¨æˆ·IDï¼š</strong><span id="userId">æ­£åœ¨è·å–...</span></p>
        <p><strong>æœ¬åœ°å­˜å‚¨æ•°æ®ï¼š</strong><span id="userDataStatus">æ­£åœ¨æ£€æŸ¥...</span></p>
      </div>
    </div>

    <!-- å¤‡ä»½æ£€æŸ¥ -->
    <div id="backupSection" class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4">æœ¬åœ°å¤‡ä»½æ£€æŸ¥</h2>
      <div id="backupStatus" class="mb-4">æ­£åœ¨æ£€æŸ¥...</div>

      <!-- å¤‡ä»½è¯¦æƒ… -->
      <div id="backupDetails" class="hidden">
        <h3 class="font-semibold mb-2">å¤‡ä»½æ•°æ®è¯¦æƒ…ï¼š</h3>
        <pre id="backupContent" class="bg-gray-100 p-4 rounded overflow-auto max-h-60 text-sm"></pre>
      </div>
    </div>

    <!-- é”™è¯¯è®°å½• -->
    <div id="errorSection" class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4">ä¿å­˜é”™è¯¯è®°å½•</h2>
      <div id="errorStatus" class="mb-4">æ­£åœ¨æ£€æŸ¥...</div>

      <!-- é”™è¯¯è¯¦æƒ… -->
      <div id="errorDetails" class="hidden">
        <h3 class="font-semibold mb-2">é”™è¯¯è¯¦æƒ…ï¼š</h3>
        <pre id="errorContent" class="bg-red-50 p-4 rounded overflow-auto max-h-60 text-sm"></pre>
      </div>
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <div id="actionsSection" class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4">æ“ä½œ</h2>
      <div class="space-x-4">
        <button id="recoverBtn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 disabled:opacity-50" disabled>
          ğŸ”„ ä»å¤‡ä»½æ¢å¤
        </button>
        <button id="retryBtn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50" disabled>
          ğŸ“ é‡æ–°å¡«å†™
        </button>
        <button id="clearBtn" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700">
          ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®
        </button>
      </div>
    </div>

    <!-- æ¢å¤ç»“æœ -->
    <div id="resultSection" class="hidden bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4">æ¢å¤ç»“æœ</h2>
      <div id="resultContent"></div>
    </div>

    <!-- è¯Šæ–­è¯´æ˜ -->
    <div class="bg-blue-50 rounded-lg shadow p-6">
      <h2 class="text-xl font-semibold mb-4">ğŸ“‹ è¯Šæ–­è¯´æ˜</h2>
      <div class="space-y-3 text-gray-700">
        <p><strong>é—®é¢˜åŸå› ï¼š</strong>ä¸ƒé—®ç­”æ¡ˆä¿å­˜å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨é”™è¯¯å¯¼è‡´ã€‚</p>
        <p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>
        <ol class="list-decimal list-inside space-y-2 ml-4">
          <li>å¦‚æœæœ¬åœ°æœ‰å¤‡ä»½ï¼Œç‚¹å‡»"ä»å¤‡ä»½æ¢å¤"æŒ‰é’®</li>
          <li>å¦‚æœæ²¡æœ‰å¤‡ä»½ï¼Œç‚¹å‡»"é‡æ–°å¡«å†™"æŒ‰é’®é‡æ–°æäº¤</li>
          <li>å¦‚æœä»ç„¶å¤±è´¥ï¼Œè¯·è”ç³»ç®¡ç†å‘˜å¹¶æä¾›é”™è¯¯è¯¦æƒ…</li>
        </ol>
        <p><strong>å¸¸è§é”™è¯¯ï¼š</strong></p>
        <ul class="list-disc list-inside space-y-1 ml-4">
          <li>ç½‘ç»œè¿æ¥è¶…æ—¶</li>
          <li>æœåŠ¡å™¨è¿”å› 500 é”™è¯¯</li>
          <li>ç”¨æˆ·åˆ›å»ºå¤±è´¥</li>
          <li>æƒé™ä¸è¶³</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    let backupData = null;
    let errorData = null;
    let userId = null;

    // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', () => {
      loadUserInfo();
      checkBackup();
      checkError();
    });

    // åŠ è½½ç”¨æˆ·ä¿¡æ¯
    function loadUserInfo() {
      const userDataStr = localStorage.getItem('userData');
      const userData = userDataStr ? JSON.parse(userDataStr) : null;
      userId = userData ? userData.id : generateUserId();

      document.getElementById('userId').textContent = userId;
      document.getElementById('userDataStatus').textContent = userDataStr ? 'âœ… æœ‰æ•°æ®' : 'âŒ æ— æ•°æ®';

      // å¦‚æœæ²¡æœ‰ç”¨æˆ·æ•°æ®ï¼Œåˆ›å»ºä¸´æ—¶ç”¨æˆ·æ•°æ®
      if (!userDataStr) {
        localStorage.setItem('userData', JSON.stringify({ id: userId }));
      }
    }

    // ç”Ÿæˆç”¨æˆ·ID
    function generateUserId() {
      let id = localStorage.getItem('userId');
      if (!id) {
        id = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('userId', id);
      }
      return id;
    }

    // æ£€æŸ¥å¤‡ä»½
    function checkBackup() {
      const backupStr = localStorage.getItem('sevenQuestionsBackup');
      const backupStatus = document.getElementById('backupStatus');
      const backupDetails = document.getElementById('backupDetails');
      const backupContent = document.getElementById('backupContent');
      const recoverBtn = document.getElementById('recoverBtn');

      if (backupStr) {
        try {
          backupData = JSON.parse(backupStr);
          backupStatus.innerHTML = `
            <div class="bg-green-100 text-green-800 p-4 rounded">
              <p class="font-semibold">âœ… æ‰¾åˆ°ä¸ƒé—®ç­”æ¡ˆå¤‡ä»½ï¼</p>
              <p>å¤‡ä»½æ—¶é—´ï¼š${new Date(backupData.timestamp).toLocaleString('zh-CN')}</p>
              <p>ç­”æ¡ˆæ•°é‡ï¼š${backupData.answers ? backupData.answers.length : 0}</p>
              <p>ç”¨æˆ·IDï¼š${backupData.userId}</p>
            </div>
          `;
          backupContent.textContent = JSON.stringify(backupData, null, 2);
          backupDetails.classList.remove('hidden');
          recoverBtn.disabled = false;
        } catch (error) {
          backupStatus.innerHTML = `
            <div class="bg-red-100 text-red-800 p-4 rounded">
              <p class="font-semibold">âŒ å¤‡ä»½æ•°æ®æŸå</p>
              <p>é”™è¯¯ï¼š${error.message}</p>
            </div>
          `;
        }
      } else {
        backupStatus.innerHTML = `
          <div class="bg-yellow-100 text-yellow-800 p-4 rounded">
            <p class="font-semibold">âš ï¸ æœªæ‰¾åˆ°æœ¬åœ°å¤‡ä»½</p>
            <p>ç”¨æˆ·å¯èƒ½æ²¡æœ‰å¡«å†™è¿‡ä¸ƒé—®ï¼Œæˆ–è€…å¤‡ä»½å·²æ¸…é™¤</p>
          </div>
        `;
        recoverBtn.disabled = true;
      }
    }

    // æ£€æŸ¥é”™è¯¯è®°å½•
    function checkError() {
      const errorStr = localStorage.getItem('sevenQuestionsSaveError');
      const errorStatus = document.getElementById('errorStatus');
      const errorDetails = document.getElementById('errorDetails');
      const errorContent = document.getElementById('errorContent');

      if (errorStr) {
        try {
          errorData = JSON.parse(errorStr);
          errorStatus.innerHTML = `
            <div class="bg-red-100 text-red-800 p-4 rounded">
              <p class="font-semibold">âŒ å‘ç°ä¿å­˜é”™è¯¯è®°å½•</p>
              <p>é”™è¯¯æ—¶é—´ï¼š${new Date(errorData.timestamp).toLocaleString('zh-CN')}</p>
              <p>é”™è¯¯æ¶ˆæ¯ï¼š${errorData.message}</p>
              <p>ç­”æ¡ˆæ•°é‡ï¼š${errorData.answersCount}</p>
            </div>
          `;
          errorContent.textContent = JSON.stringify(errorData, null, 2);
          errorDetails.classList.remove('hidden');
        } catch (error) {
          errorStatus.innerHTML = `
            <div class="bg-red-100 text-red-800 p-4 rounded">
              <p class="font-semibold">âŒ é”™è¯¯æ•°æ®æŸå</p>
              <p>é”™è¯¯ï¼š${error.message}</p>
            </div>
          `;
        }
      } else {
        errorStatus.innerHTML = `
          <div class="bg-green-100 text-green-800 p-4 rounded">
            <p class="font-semibold">âœ… æœªå‘ç°ä¿å­˜é”™è¯¯è®°å½•</p>
          </div>
        `;
      }
    }

    // ä»å¤‡ä»½æ¢å¤
    document.getElementById('recoverBtn').addEventListener('click', async () => {
      if (!backupData) {
        alert('æ²¡æœ‰å¯æ¢å¤çš„å¤‡ä»½æ•°æ®ï¼');
        return;
      }

      if (!confirm('ç¡®å®šè¦ä»å¤‡ä»½æ¢å¤ä¸ƒé—®ç­”æ¡ˆå—ï¼Ÿ\n\nè¿™å°†ç”¨çœŸå®ç­”æ¡ˆæ›¿æ¢æ•°æ®åº“ä¸­çš„é»˜è®¤ç­”æ¡ˆã€‚')) {
        return;
      }

      const recoverBtn = document.getElementById('recoverBtn');
      recoverBtn.disabled = true;
      recoverBtn.textContent = 'ğŸ”„ æ­£åœ¨æ¢å¤...';

      try {
        // æ„å»ºä¸ƒé—®ç­”æ¡ˆæ•°æ®
        const sevenQuestionsAnswers = {};
        backupData.answers.forEach(a => {
          sevenQuestionsAnswers[a.questionId.toString()] = {
            answer: a.answer,
            date: backupData.timestamp,
          };
        });

        // ä¿å­˜åˆ°æœåŠ¡å™¨
        const response = await fetch('/api/requirements', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: userId,
            sevenQuestionsAnswers: sevenQuestionsAnswers,
          }),
        });

        const result = await response.json();

        if (result.success) {
          // æ¸…é™¤æœ¬åœ°å¤‡ä»½å’Œé”™è¯¯è®°å½•
          localStorage.removeItem('sevenQuestionsBackup');
          localStorage.removeItem('sevenQuestionsSaveError');

          // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
          const resultSection = document.getElementById('resultSection');
          const resultContent = document.getElementById('resultContent');
          resultSection.classList.remove('hidden');
          resultContent.innerHTML = `
            <div class="bg-green-100 text-green-800 p-4 rounded">
              <p class="font-semibold">âœ… æ¢å¤æˆåŠŸï¼</p>
              <p>çœŸå®ç­”æ¡ˆå·²ä¿å­˜åˆ°æ•°æ®åº“ã€‚</p>
              <p class="mt-2">è¯·åˆ·æ–°åå°é¡µé¢æŸ¥çœ‹ç»“æœã€‚</p>
            </div>
          `;

          // åˆ·æ–°é¡µé¢
          setTimeout(() => {
            window.location.reload();
          }, 3000);
        } else {
          throw new Error(result.error || 'æœªçŸ¥é”™è¯¯');
        }
      } catch (error) {
        const resultSection = document.getElementById('resultSection');
        const resultContent = document.getElementById('resultContent');
        resultSection.classList.remove('hidden');
        resultContent.innerHTML = `
          <div class="bg-red-100 text-red-800 p-4 rounded">
            <p class="font-semibold">âŒ æ¢å¤å¤±è´¥</p>
            <p>é”™è¯¯ï¼š${error.message}</p>
            <p class="mt-2">è¯·é‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜ã€‚</p>
          </div>
        `;
      } finally {
        recoverBtn.disabled = false;
        recoverBtn.textContent = 'ğŸ”„ ä»å¤‡ä»½æ¢å¤';
      }
    });

    // é‡æ–°å¡«å†™
    document.getElementById('retryBtn').addEventListener('click', () => {
      // æ¸…é™¤é”™è¯¯è®°å½•
      localStorage.removeItem('sevenQuestionsSaveError');

      // è·³è½¬åˆ°å¡«å†™é¡µé¢
      window.location.href = '/analysis';
    });

    // æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®
    document.getElementById('clearBtn').addEventListener('click', () => {
      if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®å—ï¼Ÿ\n\nè¿™å°†åˆ é™¤æ‰€æœ‰å¤‡ä»½æ•°æ®å’Œç”¨æˆ·æ•°æ®ã€‚')) {
        return;
      }

      localStorage.removeItem('sevenQuestionsBackup');
      localStorage.removeItem('sevenQuestionsSaveError');
      localStorage.removeItem('userData');
      localStorage.removeItem('userId');

      alert('æ‰€æœ‰æœ¬åœ°æ•°æ®å·²æ¸…é™¤');
      window.location.reload();
    });
  </script>
</body>
</html>
