<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ£€æŸ¥ç‹åŒå­¦çš„ä¸ƒé—®å¤‡ä»½</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    .success {
      background-color: #d4edda;
      border-color: #c3e6cb;
    }
    .error {
      background-color: #f8d7da;
      border-color: #f5c6cb;
    }
    .warning {
      background-color: #fff3cd;
      border-color: #ffeaa7;
    }
    pre {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    .btn-success {
      background-color: #28a745;
      color: white;
      border: none;
    }
    .btn-danger {
      background-color: #dc3545;
      color: white;
      border: none;
    }
  </style>
</head>
<body>
  <h1>ğŸ“Š æ£€æŸ¥ç‹åŒå­¦çš„ä¸ƒé—®ç­”æ¡ˆå¤‡ä»½</h1>

  <div id="userInfo" class="section warning">
    <h3>ç”¨æˆ·ä¿¡æ¯</h3>
    <p><strong>ç”¨æˆ·IDï¼š</strong>970ef135-ad1b-4028-bab7-5006c13dab6c</p>
    <p><strong>ç”¨æˆ·åï¼š</strong>ç‹åŒå­¦</p>
    <p><strong>æ‰‹æœºå·ï¼š</strong>-</p>
  </div>

  <div id="backupCheck" class="section">
    <h3>æœ¬åœ°å­˜å‚¨æ£€æŸ¥</h3>
    <p>æ­£åœ¨æ£€æŸ¥...</p>
  </div>

  <div id="actions" class="section" style="display: none;">
    <h3>æ“ä½œ</h3>
    <button class="btn-success" onclick="recoverFromBackup()">ä»å¤‡ä»½æ¢å¤çœŸå®ç­”æ¡ˆ</button>
    <button class="btn-danger" onclick="clearBackup()">æ¸…é™¤å¤‡ä»½</button>
  </div>

  <div id="backupDetails" class="section" style="display: none;">
    <h3>å¤‡ä»½è¯¦æƒ…</h3>
    <pre id="backupContent"></pre>
  </div>

  <script>
    const TEST_USER_ID = '970ef135-ad1b-4028-bab7-5006c13dab6c';
    let backupData = null;

    function checkLocalStorage() {
      const backupDiv = document.getElementById('backupCheck');
      const actionsDiv = document.getElementById('actions');
      const backupDetailsDiv = document.getElementById('backupDetails');
      const backupContent = document.getElementById('backupContent');

      // æ£€æŸ¥ä¸ƒé—®å¤‡ä»½
      const sevenQuestionsBackup = localStorage.getItem('sevenQuestionsBackup');
      const userData = localStorage.getItem('userData');

      if (sevenQuestionsBackup) {
        try {
          backupData = JSON.parse(sevenQuestionsBackup);

          // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰ç”¨æˆ·çš„å¤‡ä»½
          if (backupData.userId === TEST_USER_ID) {
            backupDiv.innerHTML = `
              <div class="success">
                <p><strong>âœ… æ‰¾åˆ°ä¸ƒé—®ç­”æ¡ˆå¤‡ä»½ï¼</strong></p>
                <p>å¤‡ä»½æ—¶é—´ï¼š${new Date(backupData.timestamp).toLocaleString('zh-CN')}</p>
                <p>ç­”æ¡ˆæ•°é‡ï¼š${backupData.answers ? backupData.answers.length : 0}</p>
              </div>
            `;

            backupContent.textContent = JSON.stringify(backupData, null, 2);
            backupDetailsDiv.style.display = 'block';
            actionsDiv.style.display = 'block';
            return;
          } else {
            backupDiv.innerHTML = `
              <div class="warning">
                <p><strong>âš ï¸ æ‰¾åˆ°å¤‡ä»½ï¼Œä½†ä¸æ˜¯å½“å‰ç”¨æˆ·çš„</strong></p>
                <p>å¤‡ä»½ç”¨æˆ·IDï¼š${backupData.userId}</p>
                <p>å½“å‰ç”¨æˆ·IDï¼š${TEST_USER_ID}</p>
              </div>
            `;
          }
        } catch (error) {
          backupDiv.innerHTML = `
            <div class="error">
              <p><strong>âŒ è§£æå¤‡ä»½æ•°æ®å¤±è´¥</strong></p>
              <p>é”™è¯¯ï¼š${error.message}</p>
            </div>
          `;
        }
      } else {
        backupDiv.innerHTML = `
          <div class="error">
            <p><strong>âŒ æ²¡æœ‰æ‰¾åˆ°ä¸ƒé—®ç­”æ¡ˆå¤‡ä»½</strong></p>
            <p>ç”¨æˆ·å¯èƒ½æ²¡æœ‰å¡«å†™è¿‡ä¸ƒé—®ï¼Œæˆ–è€…å¤‡ä»½å·²æ¸…é™¤</p>
            <p>è§£å†³æ–¹æ¡ˆï¼šè¯·ç”¨æˆ·é‡æ–°å¡«å†™ä¸ƒé—®ç­”æ¡ˆ</p>
          </div>
        `;
      }

      // æ˜¾ç¤ºç”¨æˆ·æ•°æ®
      if (userData) {
        try {
          const parsedUserData = JSON.parse(userData);
          backupDiv.innerHTML += `
            <div class="section" style="margin-top: 20px;">
              <h4>ç”¨æˆ·æ•°æ®</h4>
              <pre>${JSON.stringify(parsedUserData, null, 2)}</pre>
            </div>
          `;
        } catch (error) {
          console.error('è§£æç”¨æˆ·æ•°æ®å¤±è´¥:', error);
        }
      }
    }

    async function recoverFromBackup() {
      if (!backupData || !backupData.answers) {
        alert('æ²¡æœ‰å¯æ¢å¤çš„å¤‡ä»½æ•°æ®ï¼');
        return;
      }

      if (!confirm('ç¡®å®šè¦ä»å¤‡ä»½æ¢å¤ä¸ƒé—®ç­”æ¡ˆå—ï¼Ÿ\n\nè¿™å°†ç”¨çœŸå®ç­”æ¡ˆæ›¿æ¢æ•°æ®åº“ä¸­çš„é»˜è®¤ç­”æ¡ˆã€‚')) {
        return;
      }

      try {
        const response = await fetch('/api/recover-local-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: TEST_USER_ID,
            data: backupData,
          }),
        });

        const result = await response.json();

        if (result.success) {
          alert('âœ… æ¢å¤æˆåŠŸï¼\n\nçœŸå®ç­”æ¡ˆå·²ä¿å­˜åˆ°æ•°æ®åº“ã€‚\nè¯·åˆ·æ–°åå°é¡µé¢æŸ¥çœ‹ç»“æœã€‚');
          localStorage.removeItem('sevenQuestionsBackup');
          checkLocalStorage();
        } else {
          alert('âŒ æ¢å¤å¤±è´¥ï¼š\n\n' + (result.error || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (error) {
        alert('âŒ æ¢å¤å¤±è´¥ï¼š\n\n' + (error.message || 'æœªçŸ¥é”™è¯¯'));
      }
    }

    function clearBackup() {
      if (confirm('ç¡®å®šè¦æ¸…é™¤æœ¬åœ°å¤‡ä»½å—ï¼Ÿ')) {
        localStorage.removeItem('sevenQuestionsBackup');
        localStorage.removeItem('userData');
        alert('æœ¬åœ°å¤‡ä»½å·²æ¸…é™¤');
        checkLocalStorage();
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
    window.onload = checkLocalStorage;
  </script>
</body>
</html>
