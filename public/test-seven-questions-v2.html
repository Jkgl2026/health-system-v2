<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–°ç‰ˆå¥åº·ä¸ƒé—®æµ‹è¯•</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">ğŸ¯ æ–°ç‰ˆå¥åº·ä¸ƒé—®æµ‹è¯•å·¥å…·</h1>

    <!-- æµ‹è¯•ç»“æœ -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4">æµ‹è¯•ç»“æœ</h2>
      <div id="testResults" class="space-y-4">
        <p class="text-gray-600">ç‚¹å‡»"å¼€å§‹æµ‹è¯•"æŒ‰é’®å¼€å§‹æµ‹è¯•...</p>
      </div>
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4">æ“ä½œ</h2>
      <div class="space-x-4">
        <button id="testBtn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700" onclick="runTests()">
          ğŸš€ å¼€å§‹æµ‹è¯•
        </button>
        <button class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700" onclick="window.location.href='/analysis'">
          ğŸ“ å¡«å†™æ–°ç‰ˆä¸ƒé—®
        </button>
        <button class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700" onclick="window.location.href='/admin/dashboard'">
          ğŸ“Š æŸ¥çœ‹åå°
        </button>
      </div>
    </div>

    <!-- ç‰ˆæœ¬å¯¹æ¯” -->
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-xl font-semibold mb-4">ç‰ˆæœ¬å¯¹æ¯”</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="border-2 border-red-200 rounded-lg p-4">
          <h3 class="font-semibold text-red-800 mb-2">âŒ V1 æ—§ç‰ˆ</h3>
          <ul class="text-sm space-y-1">
            <li>â€¢ å¤šé•¿æ—¶é—´çŠ¯ä¸€æ¬¡ï¼Ÿ</li>
            <li>â€¢ ä¸€æ¬¡è¦å¤šä¹…ï¼Ÿ</li>
            <li>â€¢ å…·ä½“è¡¨ç°æ˜¯ä»€ä¹ˆï¼Ÿ</li>
            <li>â€¢ ç”¨äº†å“ªäº›æ–¹æ³•å¹²é¢„ï¼Ÿ</li>
            <li>â€¢ ç—‡çŠ¶ä»ä»€ä¹ˆæ—¶å€™å¼€å§‹çš„ï¼Ÿ</li>
            <li>â€¢ ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‡è½»ï¼Ÿ</li>
            <li>â€¢ æœ€è¿‘ä¸€æ¬¡å‡ºç°æ˜¯ä»€ä¹ˆæ—¶å€™ï¼Ÿ</li>
          </ul>
          <p class="text-xs text-gray-600 mt-2">å…³æ³¨ç—‡çŠ¶æè¿°ï¼Œè¢«åŠ¨åº”å¯¹</p>
        </div>
        <div class="border-2 border-green-200 rounded-lg p-4">
          <h3 class="font-semibold text-green-800 mb-2">âœ… V2 æ–°ç‰ˆ</h3>
          <ul class="text-sm space-y-1">
            <li>â€¢ æ‚¨çš„ç¡çœ æƒ…å†µå¦‚ä½•ï¼Ÿ</li>
            <li>â€¢ æ‚¨å¹³æ—¶çš„é¥®é£Ÿä¹ æƒ¯æ˜¯æ€æ ·çš„ï¼Ÿ</li>
            <li>â€¢ æ‚¨æ¯å‘¨ä¼šè¿åŠ¨å—ï¼Ÿ</li>
            <li>â€¢ æ‚¨çš„å·¥ä½œå‹åŠ›å¤§å—ï¼Ÿ</li>
            <li>â€¢ æ‚¨çš„æƒ…ç»ªçŠ¶æ€å¦‚ä½•ï¼Ÿ</li>
            <li>â€¢ æ‚¨æœ€å¸Œæœ›æ”¹å–„çš„å¥åº·é—®é¢˜ï¼Ÿ</li>
            <li>â€¢ æ‚¨æ„¿æ„åšå‡ºå“ªäº›æ”¹å˜ï¼Ÿ</li>
          </ul>
          <p class="text-xs text-gray-600 mt-2">å…³æ³¨ç”Ÿæ´»ä¹ æƒ¯ï¼Œä¸»åŠ¨é¢„é˜²</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function runTests() {
      const testResults = document.getElementById('testResults');
      const testBtn = document.getElementById('testBtn');
      
      testBtn.disabled = true;
      testBtn.textContent = 'ğŸ”„ æµ‹è¯•ä¸­...';
      testResults.innerHTML = '<p class="text-blue-600">æ­£åœ¨è¿è¡Œæµ‹è¯•...</p>';

      try {
        // æµ‹è¯•1: æ£€æŸ¥æ–°ç‰ˆä¸ƒé—®æ•°æ®
        addTestResult('æ£€æŸ¥æ–°ç‰ˆä¸ƒé—®æ•°æ®ç»“æ„', 'æ­£åœ¨æ£€æŸ¥...');
        await new Promise(resolve => setTimeout(resolve, 500));
        
        const response1 = await fetch('/api/test-seven-questions');
        const result1 = await response1.json();
        
        if (result1.success) {
          addTestResult('æ£€æŸ¥æ–°ç‰ˆä¸ƒé—®æ•°æ®ç»“æ„', 'âœ… é€šè¿‡', 'æˆåŠŸåŠ è½½æ–°ç‰ˆä¸ƒé—®æ•°æ®ï¼ŒåŒ…å«7ä¸ªé—®é¢˜');
        } else {
          addTestResult('æ£€æŸ¥æ–°ç‰ˆä¸ƒé—®æ•°æ®ç»“æ„', 'âŒ å¤±è´¥', result1.error);
        }

        // æµ‹è¯•2: æ£€æŸ¥ç”¨æˆ·æ•°æ®
        addTestResult('æ£€æŸ¥ç”¨æˆ·æ•°æ®å…¼å®¹æ€§', 'æ­£åœ¨æ£€æŸ¥...');
        await new Promise(resolve => setTimeout(resolve, 500));
        
        const userId = 'test_user_' + Date.now();
        const response2 = await fetch('/api/user', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: 'æµ‹è¯•ç”¨æˆ·_æ–°ç‰ˆä¸ƒé—®',
            phone: '13800000000',
          }),
        });
        
        const result2 = await response2.json();
        
        if (result2.success) {
          addTestResult('æ£€æŸ¥ç”¨æˆ·æ•°æ®å…¼å®¹æ€§', 'âœ… é€šè¿‡', `æˆåŠŸåˆ›å»ºç”¨æˆ·ï¼ŒID: ${result2.user.id}`);
          
          // æµ‹è¯•3: ä¿å­˜æ–°ç‰ˆä¸ƒé—®ç­”æ¡ˆ
          addTestResult('ä¿å­˜æ–°ç‰ˆä¸ƒé—®ç­”æ¡ˆ', 'æ­£åœ¨ä¿å­˜...');
          await new Promise(resolve => setTimeout(resolve, 500));
          
          const response3 = await fetch('/api/requirements', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              userId: result2.user.id,
              sevenQuestionsAnswers: {
                '1': { answer: 'æˆ‘æ¯å¤©ç¡8å°æ—¶ï¼Œç¡çœ è´¨é‡å¾ˆå¥½', date: new Date().toISOString() },
                '2': { answer: 'ä¸€æ—¥ä¸‰é¤è§„å¾‹ï¼Œå°‘æ²¹å°‘ç›', date: new Date().toISOString() },
                '3': { answer: 'æ¯å‘¨è·‘æ­¥3æ¬¡ï¼Œæ¯æ¬¡30åˆ†é’Ÿ', date: new Date().toISOString() },
                '4': { answer: 'å·¥ä½œå‹åŠ›é€‚ä¸­ï¼Œå¶å°”åŠ ç­', date: new Date().toISOString() },
                '5': { answer: 'æƒ…ç»ªç¨³å®šï¼Œå¶å°”æœ‰å‹åŠ›', date: new Date().toISOString() },
                '6': { answer: 'æœ€å¸Œæœ›æ”¹å–„ç¡çœ è´¨é‡', date: new Date().toISOString() },
                '7': { answer: 'æ„¿æ„è°ƒæ•´ä½œæ¯ï¼ŒåšæŒè¿åŠ¨', date: new Date().toISOString() },
              },
            }),
          });
          
          const result3 = await response3.json();
          
          if (result3.success) {
            addTestResult('ä¿å­˜æ–°ç‰ˆä¸ƒé—®ç­”æ¡ˆ', 'âœ… é€šè¿‡', 'æˆåŠŸä¿å­˜7ä¸ªé—®é¢˜çš„ç­”æ¡ˆ');
            
            // æµ‹è¯•4: è¯»å–ä¸ƒé—®ç­”æ¡ˆ
            addTestResult('è¯»å–ä¸ƒé—®ç­”æ¡ˆ', 'æ­£åœ¨è¯»å–...');
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const response4 = await fetch(`/api/user/requirements?userId=${result2.user.id}`);
            const result4 = await response4.json();
            
            if (result4.success && result4.requirement?.sevenQuestionsAnswers) {
              const answers = result4.requirement.sevenQuestionsAnswers;
              const answerCount = Object.keys(answers).length;
              addTestResult('è¯»å–ä¸ƒé—®ç­”æ¡ˆ', 'âœ… é€šè¿‡', `æˆåŠŸè¯»å–${answerCount}ä¸ªé—®é¢˜çš„ç­”æ¡ˆ`);
            } else {
              addTestResult('è¯»å–ä¸ƒé—®ç­”æ¡ˆ', 'âŒ å¤±è´¥', 'æ— æ³•è¯»å–ä¸ƒé—®ç­”æ¡ˆ');
            }
          } else {
            addTestResult('ä¿å­˜æ–°ç‰ˆä¸ƒé—®ç­”æ¡ˆ', 'âŒ å¤±è´¥', result3.error);
          }
        } else {
          addTestResult('æ£€æŸ¥ç”¨æˆ·æ•°æ®å…¼å®¹æ€§', 'âŒ å¤±è´¥', result2.error);
        }

        addTestResult('æµ‹è¯•å®Œæˆ', 'âœ… å…¨éƒ¨æµ‹è¯•é€šè¿‡', 'æ–°ç‰ˆå¥åº·ä¸ƒé—®åŠŸèƒ½æ­£å¸¸ï¼');

      } catch (error) {
        addTestResult('æµ‹è¯•å¤±è´¥', 'âŒ å‘ç”Ÿé”™è¯¯', error.message);
      } finally {
        testBtn.disabled = false;
        testBtn.textContent = 'ğŸš€ å¼€å§‹æµ‹è¯•';
      }
    }

    function addTestResult(name, status, detail) {
      const testResults = document.getElementById('testResults');
      const statusClass = status.includes('âœ…') ? 'text-green-600' : status.includes('âŒ') ? 'text-red-600' : 'text-blue-600';
      
      const resultHtml = `
        <div class="border-l-4 pl-4 py-2 ${status.includes('âœ…') ? 'border-green-500 bg-green-50' : status.includes('âŒ') ? 'border-red-500 bg-red-50' : 'border-blue-500 bg-blue-50'}">
          <div class="font-semibold ${statusClass}">${name} - ${status}</div>
          ${detail ? `<div class="text-sm text-gray-600 mt-1">${detail}</div>` : ''}
        </div>
      `;
      
      testResults.innerHTML += resultHtml;
    }
  </script>
</body>
</html>
