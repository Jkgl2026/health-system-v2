# 连接问题故障排除指南

## 问题描述
用户报告看到错误消息：`{"detail":"无法连接到后端服务"}`

## 可能的原因和解决方案

### 1. 浏览器缓存问题
**症状**：页面显示旧的代码或错误提示
**解决方案**：
- 清除浏览器缓存（Ctrl+Shift+Delete 或 Cmd+Shift+Delete）
- 硬刷新页面（Ctrl+F5 或 Cmd+Shift+R）
- 尝试无痕/隐私模式

### 2. 网络连接问题
**症状**：请求超时或无法建立连接
**解决方案**：
- 检查网络连接是否正常
- 尝试刷新页面
- 检查是否有防火墙或安全软件拦截
- 检查浏览器控制台（F12）的Network标签，查看请求状态

### 3. 服务未正常运行
**症状**：5000端口无响应
**检查方法**：
```bash
# 检查服务是否运行
curl -I http://localhost:5000

# 检查端口监听状态
ss -lptn 'sport = :5000'
```
**解决方案**：
- 如果服务未运行，启动服务：
```bash
cd /workspace/projects
coze dev >/dev/null 2>&1 &
```

### 4. 浏览器扩展干扰
**症状**：某些扩展拦截或修改了请求
**解决方案**：
- 暂时禁用所有浏览器扩展
- 使用无痕模式测试
- 逐个启用扩展，找出问题扩展

### 5. 代理或VPN设置
**症状**：通过代理访问时出现连接问题
**解决方案**：
- 暂时关闭代理或VPN
- 添加 localhost 和 127.0.0.1 到代理例外列表
- 使用直连方式访问

### 6. CORS问题（通常不会发生，因为前后端同域）
**症状**：浏览器控制台显示CORS错误
**解决方案**：
- 确认前后端使用相同的协议、域名和端口
- 检查 .coze 配置文件中的运行端口设置

### 7. API错误处理
**症状**：API返回错误响应
**解决方案**：
- 使用页面右上角的"诊断"按钮运行系统诊断
- 查看诊断结果，根据建议进行修复
- 检查日志文件：
```bash
tail -n 30 /app/work/logs/bypass/app.log
```

## 使用诊断工具

数据对比页面现在内置了诊断工具，可以帮助快速定位问题：

1. 点击页面右上角的"诊断"按钮
2. 系统会自动运行以下测试：
   - 服务可访问性
   - 健康检查API
   - 历史记录API
   - 网络环境检查
3. 查看测试结果和详细信息
4. 根据结果和提示进行修复

## 详细调试步骤

### 步骤1：检查服务状态
```bash
# 检查服务是否运行
ps aux | grep next-server

# 检查端口是否监听
ss -lptn 'sport = :5000'

# 测试服务响应
curl -I http://localhost:5000
```

### 步骤2：检查浏览器控制台
1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签
3. 查看是否有 JavaScript 错误
4. 切换到 Network 标签
5. 重新加载页面，观察所有请求的状态
6. 找到失败的请求，查看详细信息和响应

### 步骤3：检查日志
```bash
# 查看应用日志
tail -n 30 /app/work/logs/bypass/app.log

# 如果需要更详细的日志
tail -n 30 /app/work/logs/bypass/dev.log
```

### 步骤4：测试API
```bash
# 测试健康检查API
curl http://localhost:5000/api/health

# 测试历史记录API
curl "http://localhost:5000/api/user/history?phone=13800138000"

# 测试用户详情API（替换为实际用户ID）
curl http://localhost:5000/api/admin/users/<用户ID>
```

## 常见错误及解决方案

### 错误1：Failed to fetch
**原因**：网络连接问题或CORS错误
**解决方案**：
- 检查网络连接
- 确认服务正常运行
- 尝试清除缓存

### 错误2：请求超时
**原因**：服务器响应太慢或网络延迟
**解决方案**：
- 检查服务器负载
- 优化数据库查询
- 增加超时时间（已在代码中设置为10-30秒）

### 错误3：HTTP 500错误
**原因**：服务器内部错误
**解决方案**：
- 查看服务器日志
- 检查数据库连接
- 确认所有表结构正确

### 错误4：HTTP 404错误
**原因**：API路由不存在
**解决方案**：
- 确认API路由文件存在
- 检查路由路径是否正确
- 重新启动服务

## 联系支持

如果以上方法都无法解决问题，请提供以下信息：
1. 错误消息的完整内容
2. 浏览器控制台的截图（Console和Network标签）
3. 诊断工具的测试结果
4. 服务器日志的最后30行
5. 使用的浏览器类型和版本
6. 操作系统类型和版本

## 预防措施

1. **定期检查服务状态**
   - 定期运行健康检查API
   - 监控服务器日志
   - 检查数据库连接状态

2. **保持代码更新**
   - 定期更新依赖包
   - 遵循代码规范
   - 进行充分的测试

3. **监控和告警**
   - 设置服务监控
   - 配置错误告警
   - 定期备份数据

4. **文档维护**
   - 更新API文档
   - 记录常见问题
   - 提供故障排除指南
