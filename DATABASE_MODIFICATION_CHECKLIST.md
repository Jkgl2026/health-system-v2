# 数据库修改安全检查清单

## ⚠️ 重要警告
**每次修改数据库相关代码前，必须完成以下检查！**
**跳过任何一步都可能导致数据丢失或访问失败！**

---

## 📋 修改前检查（必须全部通过）

### 1. 识别变更类型
- [ ] **Schema 变更** - 添加、修改、删除表或列
- [ ] **数据变更** - 修改现有数据
- [ ] **API 变更** - 修改数据库查询或操作逻辑
- [ ] **UI 变更** - 仅修改前端展示（无数据库操作）

### 2. 如果是 Schema 变更
- [ ] 在 `src/lib/databaseMigration.ts` 的 `MIGRATION_STEPS` 中添加对应的迁移步骤
- [ ] 迁移步骤包含：
  - `name`: 唯一标识符
  - `description`: 描述变更内容
  - `check()`: 检查是否需要执行迁移
  - `execute()`: 执行迁移的 SQL
- [ ] 使用 `ADD COLUMN IF NOT EXISTS` 避免重复执行错误
- [ ] 不使用 `DROP COLUMN` 或 `DROP TABLE`（除非有明确的回滚方案）

### 3. 备份数据
- [ ] 运行 `/api/backup` 创建备份
- [ ] 记录备份 ID
- [ ] 确认备份成功
- [ ] 备份文件已保存到对象存储

### 4. 测试环境验证
- [ ] 在测试环境先执行迁移
- [ ] 验证数据完整性
- [ ] 确认所有 API 正常响应
- [ ] 确认管理后台可以访问

### 5. 本地验证
- [ ] 访问 `/db-schema-check` 确认当前结构
- [ ] 运行 `/api/_init` 执行迁移
- [ ] 再次访问 `/db-schema-check` 确认迁移成功
- [ ] 测试受影响的 API 端点

### 6. 文档更新
- [ ] 更新 `DATA_LOSS_ISSUE_RESOLVED.md`（如果解决了问题）
- [ ] 记录变更内容到本次提交信息
- [ ] 更新相关的 README 或文档

---

## 🔧 修改执行流程

### 对于 Schema 变更
```bash
# 1. 备份数据
curl -X POST http://localhost:5000/api/backup

# 2. 检查当前结构
curl http://localhost:5000/api/db-schema-check

# 3. 添加迁移步骤到 src/lib/databaseMigration.ts

# 4. 执行迁移
curl http://localhost:5000/api/_init

# 5. 验证迁移结果
curl http://localhost:5000/api/db-schema-check

# 6. 测试 API
curl http://localhost:5000/api/admin/users
```

### 对于 API 逻辑变更
```bash
# 1. 备份数据（以防万一）
curl -X POST http://localhost:5000/api/backup

# 2. 修改代码
# 编辑对应的 API 路由文件

# 3. 重启服务（如果有必要）
# 热更新通常不需要

# 4. 测试 API
curl -X POST http://localhost:5000/api/xxx \
  -H "Content-Type: application/json" \
  -d '{...}'
```

---

## ✅ 修改后验证（必须全部通过）

### 1. 结构验证
- [ ] 访问 `/db-schema-check` 确认结构一致
- [ ] 没有缺失的列
- [ ] 没有多余的列（除非是有意添加）

### 2. 功能验证
- [ ] 用户可以正常登录
- [ ] 用户可以正常填写表单
- [ ] 数据可以正常保存
- [ ] 管理后台可以正常访问
- [ ] 所有 API 端点返回 200

### 3. 数据完整性验证
- [ ] 用户数量不变
- [ ] 用户数据完整
- [ ] 关联数据完整
- [ ] 没有数据损坏

### 4. 性能验证
- [ ] API 响应时间正常
- [ ] 没有慢查询日志
- [ ] 内存使用正常

---

## 🚨 紧急回滚流程

### 如果迁移失败
```bash
# 1. 立即停止修改
# 2. 恢复备份
curl -X POST http://localhost:5000/api/restore/{backupId}

# 3. 验证恢复成功
curl http://localhost:5000/api/admin/users

# 4. 分析失败原因
# 查看日志: tail -n 50 /app/work/logs/bypass/app.log
```

### 如果数据丢失
```bash
# 1. 立即停止服务
# 2. 不要进行任何数据库操作
# 3. 联系数据库管理员
# 4. 从最近的备份恢复
```

---

## 📝 常见错误案例

### ❌ 错误 1：修改 schema 但不执行迁移
**后果**：代码引用不存在的列，API 500 错误
**正确做法**：在 `databaseMigration.ts` 中添加迁移步骤

### ❌ 错误 2：使用 DROP COLUMN
**后果**：数据永久丢失
**正确做法**：只添加列，不删除列

### ❌ 错误 3：不备份数据就修改
**后果**：无法回滚，数据永久丢失
**正确做法**：修改前必须备份

### ❌ 错误 4：只测试一个 API
**后果**：其他 API 可能失败
**正确做法**：测试所有受影响的 API

### ❌ 错误 5：不检查数据完整性
**后果**：可能造成数据损坏
**正确做法**：验证用户数量和关联数据

---

## 🎯 最佳实践

1. **小步快跑**：每次只修改一个小的功能
2. **频繁测试**：每次修改后立即测试
3. **定期备份**：每天至少备份一次
4. **文档先行**：先写文档再写代码
5. **版本控制**：使用 git 管理所有变更
6. **代码审查**：重要变更需要审查

---

## 📞 问题处理

如果遇到问题：
1. 不要慌，先停止所有操作
2. 记录错误信息
3. 检查日志文件
4. 尝试恢复备份
5. 寻求帮助

---

**最后更新**: 2026-01-24
**适用版本**: v1.0+
