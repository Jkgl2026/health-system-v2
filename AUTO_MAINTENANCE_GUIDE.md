# 自动维护功能使用指南

## 概述

自动维护功能允许系统自动执行数据库维护任务，无需人工干预。系统会按照预定的时间表自动执行以下维护操作：

- **ANALYZE**: 每天凌晨2点执行，更新统计信息，优化查询计划
- **VACUUM**: 每周日凌晨3点执行，清理死元组，回收空间
- **REINDEX**: 每月1号凌晨4点执行，重建索引，提高查询性能

## 功能特点

### 1. 自动化调度
- 使用node-cron库实现定时任务调度
- 支持自定义Cron表达式
- 支持动态修改调度配置

### 2. 灵活控制
- 可以单独启动/停止每个任务
- 可以立即执行任何任务（用于测试）
- 实时查看任务状态和执行结果

### 3. 执行记录
- 保存最近100条执行记录
- 显示每次执行的状态、耗时和时间戳
- 提供统计数据（总执行次数、成功率、平均耗时）

## API接口

### 1. 获取自动维护状态
```
GET /api/admin/auto-maintenance
```

返回数据：
```json
{
  "success": true,
  "data": {
    "schedules": [
      {
        "task": "analyze",
        "schedule": "0 2 * * *",
        "lastRun": null,
        "nextRun": null,
        "enabled": true,
        "isRunning": true
      },
      ...
    ],
    "results": [
      {
        "task": "analyze",
        "status": "success",
        "message": "任务执行成功",
        "timestamp": "2026-01-25T04:18:47.634Z",
        "duration": 346
      },
      ...
    ],
    "stats": {
      "totalRuns": 3,
      "successRuns": 3,
      "errorRuns": 0,
      "successRate": "100.00",
      "averageDuration": 424
    }
  }
}
```

### 2. 启动自动维护
```
POST /api/admin/maintenance
Content-Type: application/json

{
  "action": "auto-start",
  "task": "analyze"  // 可选，不指定则启动所有任务
}
```

### 3. 停止自动维护
```
POST /api/admin/maintenance
Content-Type: application/json

{
  "action": "auto-stop",
  "task": "vacuum"  // 可选，不指定则停止所有任务
}
```

### 4. 更新调度配置
```
POST /api/admin/maintenance
Content-Type: application/json

{
  "action": "auto-update",
  "task": "analyze",
  "schedule": "0 2 * * *",
  "enabled": true
}
```

### 5. 立即执行任务
```
POST /api/admin/maintenance
Content-Type: application/json

{
  "action": "auto-run",
  "task": "analyze"
}
```

## Cron表达式说明

| Cron表达式 | 说明 | 任务 |
|-----------|------|------|
| `0 2 * * *` | 每天凌晨2点 | ANALYZE |
| `0 3 * * 0` | 每周日凌晨3点 | VACUUM |
| `0 4 1 * *` | 每月1号凌晨4点 | REINDEX |

Cron表达式格式：`分钟 小时 日 月 星期`

## 管理后台使用

访问 `/admin/maintenance` 页面，可以看到自动维护控制面板。

### 功能说明

1. **自动维护配置**
   - 显示所有任务的配置信息
   - 显示任务的上次运行时间和下次运行时间
   - 支持启动/停止每个任务
   - 支持立即执行任务

2. **统计信息**
   - 总执行次数
   - 成功率
   - 平均耗时
   - 失败次数

3. **执行历史**
   - 显示最近20次执行记录
   - 每条记录包含任务名称、执行时间、状态、耗时

## 注意事项

1. **服务重启后重置**
   - 由于使用内存存储，服务重启后调度器会重置为默认配置
   - 需要重新启动自动维护任务

2. **任务执行时间**
   - 确保在低峰期执行维护任务
   - VACUUM操作会锁定表，影响查询性能
   - REINDEX操作会重建索引，可能需要较长时间

3. **磁盘空间**
   - VACUUM操作需要额外的磁盘空间
   - 确保有足够的磁盘空间执行维护操作

4. **监控建议**
   - 定期检查执行历史
   - 关注失败任务的错误信息
   - 监控数据库大小和性能指标

## 默认调度配置

### ANALYZE（每天执行）
- **时间**: 每天凌晨2点
- **Cron**: `0 2 * * *`
- **作用**: 更新统计信息，优化查询计划
- **建议**: 每天执行，保证查询性能

### VACUUM（每周执行）
- **时间**: 每周日凌晨3点
- **Cron**: `0 3 * * 0`
- **作用**: 清理死元组，回收空间
- **建议**: 每周执行一次，平衡维护频率和性能影响

### REINDEX（每月执行）
- **时间**: 每月1号凌晨4点
- **Cron**: `0 4 1 * *`
- **作用**: 重建索引，提高查询性能
- **建议**: 每月执行一次，避免索引碎片化

## 故障排查

### 任务未自动执行
1. 检查任务是否已启动
2. 检查Cron表达式是否正确
3. 检查服务器时间是否正确
4. 查看日志获取错误信息

### 任务执行失败
1. 查看执行历史中的错误信息
2. 检查数据库连接是否正常
3. 检查磁盘空间是否充足
4. 检查是否有其他进程锁定表

### 调度器状态丢失
1. 服务重启后需要重新启动自动维护
2. 使用API手动启动所有任务
3. 考虑实现持久化存储（如数据库）

## 最佳实践

1. **定期检查**: 每周检查一次执行历史，确保任务正常执行
2. **测试验证**: 在生产环境使用前，先在测试环境验证
3. **渐进调整**: 根据实际使用情况调整执行频率
4. **备份恢复**: 执行重要维护前先备份
5. **监控告警**: 设置任务失败告警机制

## 技术实现

### 核心组件

1. **自动维护调度器** (`src/lib/autoMaintenanceScheduler.ts`)
   - 管理所有自动维护任务
   - 使用node-cron实现定时调度
   - 保存执行记录和统计信息

2. **维护API** (`src/app/api/admin/maintenance/route.ts`)
   - 提供任务执行接口
   - 提供调度管理接口
   - 导出维护函数供调度器使用

3. **自动维护组件** (`src/components/admin/AutoMaintenance.tsx`)
   - 提供可视化控制界面
   - 显示任务状态和执行历史
   - 支持启动/停止/立即执行

### 依赖

- node-cron: 定时任务调度库
- Next.js API: 提供RESTful接口
- React: 提供用户界面

## 版本历史

- **v1.0.0** (2026-01-25)
  - 初始版本
  - 支持三个自动维护任务（ANALYZE、VACUUM、REINDEX）
  - 提供管理后台控制界面
  - 支持任务状态查询和执行历史

## 联系支持

如有问题或建议，请联系技术支持团队。
